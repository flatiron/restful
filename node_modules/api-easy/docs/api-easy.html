<!DOCTYPE html>  <html> <head>   <title>api-easy.js</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               api-easy.js             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>                            </td>             <td class="code">               <div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * api-easy.js: Top-level include for the api-easy module.</span>
<span class="cm"> *</span>
<span class="cm"> * (C) 2011, Nodejitsu Inc.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="kd">var</span> <span class="nx">assert</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;assert&#39;</span><span class="p">),</span>
    <span class="nx">fs</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;fs&#39;</span><span class="p">),</span>
    <span class="nx">path</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;path&#39;</span><span class="p">),</span>
    <span class="nx">qs</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;querystring&#39;</span><span class="p">),</span>
    <span class="nx">request</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;request&#39;</span><span class="p">),</span>
    <span class="nx">vows</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;vows&#39;</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <h3>Check for version info in <code>package.json</code></h3>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;pkginfo&#39;</span><span class="p">)(</span><span class="nx">module</span><span class="p">,</span> <span class="s1">&#39;version&#39;</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <h2>APIeasy.describe(text, vowsSuite)</h2>

<p>This is the main (and sole) entry point for APIeasy.
It responds with an object literal that manages an 
underlying vows suite. Each call to <code>APIeasy.describe()</code> 
will create a vows suite, with the corresponding <code>text</code> 
passed to this method.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">exports</span><span class="p">.</span><span class="nx">describe</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">text</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <h3>State / Context management:</h3>

<ul>
<li><code>suite</code>: The underlying vows suite</li>
<li><code>discussion</code>: Ordered list containing the set of text to use before each test</li>
<li><code>outgoing</code>: Shared options to be passed to the <code>request</code> module on each test.</li>
<li><code>befores</code>: Mapping of named functions to execute before each test to modify the 
        outgoing request options.</li>
<li><code>options</code>: Various configuration options for managing nuances of state / scope.</li>
<li><code>paths</code>: The set of paths representing the location of the current resource / 
       API method being tested by this object.</li>
<li><code>batch</code>: The object literal representing the current batch of vows tests to 
       eventually be pass to vows <code>.addBatch()</code>.</li>
<li><code>batches</code>: The set of all batches that have been added to the vows <code>suite</code> 
         associated with this object.</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">suite</span><span class="o">:</span> <span class="nx">vows</span><span class="p">.</span><span class="nx">describe</span><span class="p">(</span><span class="nx">text</span><span class="p">),</span>
    <span class="nx">discussion</span><span class="o">:</span> <span class="p">[],</span>
    <span class="nx">outgoing</span><span class="o">:</span> <span class="p">{</span>
      <span class="nx">headers</span><span class="o">:</span> <span class="p">{}</span>
    <span class="p">},</span>
    <span class="nx">befores</span><span class="o">:</span> <span class="p">{},</span>
    <span class="nx">options</span><span class="o">:</span> <span class="p">{},</span>
    <span class="nx">paths</span><span class="o">:</span> <span class="p">[],</span>
    <span class="nx">batch</span><span class="o">:</span> <span class="p">{},</span>
    <span class="nx">batches</span><span class="o">:</span> <span class="p">[],</span>
    </pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <h3>Add and Remove BDD Discussion</h3>

<p>Simple pathing for adding contextual description to sets of tests. 
Each call to discuss will create an object in the nested vows 
structure which has that text as the key in the parent. <strong>e.g.:</strong></p>

<pre><code>APIeasy.describe('your/awesome/api')
        .use('localhost', 8080)
        .discuss('When using your awesome API')
          .discuss('and an awesome resource')
          .path('/awesome-resource')
            .get().expect(200)
          .undiscuss().unpath()
          .discuss('and a super resource')
          .path('/super-resource')
            .get().expect(404);
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">discuss</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">text</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">discussion</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">text</span><span class="p">);</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
    <span class="p">},</span>
    <span class="nx">undiscuss</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">length</span> <span class="o">=</span> <span class="nx">length</span> <span class="o">||</span> <span class="mi">1</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">discussion</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="nx">length</span><span class="p">,</span> <span class="nx">length</span><span class="p">);</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
    <span class="p">},</span>
    </pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <h3>Setup Remote API Location / Options</h3>

<p>Configure the remote <code>host</code>, <code>port</code>, and miscellaneous
<code>options</code> of the API that this suite is testing.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">use</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">host</span> <span class="cm">/* [port, options] */</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">args</span> <span class="o">=</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">slice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">arguments</span><span class="p">),</span>
          <span class="nx">options</span> <span class="o">=</span> <span class="k">typeof</span> <span class="nx">args</span><span class="p">[</span><span class="nx">args</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">===</span> <span class="s1">&#39;object&#39;</span> <span class="o">?</span> <span class="nx">args</span><span class="p">.</span><span class="nx">pop</span><span class="p">()</span> <span class="o">:</span> <span class="p">{},</span>
          <span class="nx">port</span> <span class="o">=</span> <span class="nx">args</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

      <span class="k">this</span><span class="p">.</span><span class="nx">host</span>   <span class="o">=</span> <span class="nx">host</span> <span class="o">||</span> <span class="s1">&#39;localhost&#39;</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">port</span>   <span class="o">=</span> <span class="nx">port</span> <span class="o">||</span> <span class="mi">80</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">secure</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">secure</span> <span class="o">||</span> <span class="kc">false</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p><strong>TODO <em>(indexzero)</em>:</strong> Setup <code>this.options</code> here (i.e. options for the SUITE, not the REQUEST)
<em>What are useful options to expose?</em></p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
    <span class="p">},</span>
    </pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <h3>Configure Headers</h3>

<p>Manipulate the HTTP headers that are sent to your API using these methods. 
They are designed to mimic the node.js core HTTP APIs.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">setHeaders</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">headers</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">outgoing</span><span class="p">.</span><span class="nx">headers</span> <span class="o">=</span> <span class="nx">headers</span><span class="p">;</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
    <span class="p">},</span>
    <span class="nx">setHeader</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">outgoing</span><span class="p">.</span><span class="nx">headers</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
    <span class="p">},</span>
    <span class="nx">removeHeader</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">delete</span> <span class="k">this</span><span class="p">.</span><span class="nx">outgoing</span><span class="p">.</span><span class="nx">headers</span><span class="p">[</span><span class="nx">key</span><span class="p">];</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
    <span class="p">},</span>
    </pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <h3>Manipulate Base Path</h3>

<p>Control the base path used for a given test in this suite. Append a path
by calling <code>.path()</code>. Remove the last <code>num</code> paths from the suite by calling 
<code>.unpath(num)</code>. Set the root path using <code>.root(path)</code> </p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">path</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">uri</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">paths</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">uri</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/^\/|\/$/ig</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">));</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
    <span class="p">},</span>
    <span class="nx">unpath</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">length</span> <span class="o">=</span> <span class="nx">length</span> <span class="o">||</span> <span class="mi">1</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">paths</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="nx">length</span><span class="p">,</span> <span class="nx">length</span><span class="p">);</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
    <span class="p">},</span>
    <span class="nx">root</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">path</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">paths</span> <span class="o">=</span> <span class="p">[</span><span class="nx">path</span><span class="p">];</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
    <span class="p">},</span>
    </pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <h3>Dynamically set Outgoing Request Options</h3>

<p>Often it is necessary to set some HTTP options conditionally or based on 
results of a dynamic and/or asynchronous operation. A call to <code>.before()</code> 
will enqueue a function that will modify the outgoing request options 
before the request is made for all tests on the suite.      </p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">before</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">fn</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">befores</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="nx">fn</span><span class="p">;</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
    <span class="p">},</span>
    <span class="nx">unbefore</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">delete</span> <span class="k">this</span><span class="p">.</span><span class="nx">befores</span><span class="p">[</span><span class="nx">name</span><span class="p">];</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
    <span class="p">},</span>
    </pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <h3>Add HTTP Request-based Tests</h3>

<p>The <code>.get()</code>, <code>.post()</code>, <code>.put()</code>, <code>.del()</code>, and <code>.head()</code> 
methods add a new context and topic to the vows structure maintained
by this APIeasy suite. The nuts and bolts of this are in the "private"
method <code>_request()</code>.</p>

<p>Each method invocation returns the suite itself so that 
<code>.expect()</code> and other assertion method(s) can be called 
afterwards to add assertions to this context.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">get</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="cm">/* [uri, params] */</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">args</span> <span class="o">=</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">slice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">arguments</span><span class="p">);</span>
      <span class="nx">args</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="kc">null</span><span class="p">);</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_request</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;get&#39;</span><span class="p">].</span><span class="nx">concat</span><span class="p">(</span><span class="nx">args</span><span class="p">));</span>
    <span class="p">},</span>
    <span class="nx">post</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="cm">/* [uri, data, params] */</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">args</span> <span class="o">=</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">slice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">arguments</span><span class="p">);</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_request</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;post&#39;</span><span class="p">].</span><span class="nx">concat</span><span class="p">(</span><span class="nx">args</span><span class="p">));</span>
    <span class="p">},</span>
    <span class="nx">put</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="cm">/* [uri, data, params] */</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">args</span> <span class="o">=</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">slice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">arguments</span><span class="p">);</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_request</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;put&#39;</span><span class="p">].</span><span class="nx">concat</span><span class="p">(</span><span class="nx">args</span><span class="p">));</span>
    <span class="p">},</span>
    <span class="nx">del</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="cm">/* [uri, data, params] */</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">args</span> <span class="o">=</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">slice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">arguments</span><span class="p">);</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_request</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;delete&#39;</span><span class="p">].</span><span class="nx">concat</span><span class="p">(</span><span class="nx">args</span><span class="p">));</span>
    <span class="p">},</span>
    <span class="nx">head</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="cm">/* [uri, params] */</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">args</span> <span class="o">=</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">slice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">arguments</span><span class="p">);</span>
      <span class="nx">args</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="kc">null</span><span class="p">);</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_request</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;head&#39;</span><span class="p">].</span><span class="nx">concat</span><span class="p">(</span><span class="nx">args</span><span class="p">));</span>
    <span class="p">},</span>
    <span class="nx">uploadFile</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="cm">/* [uri, filepath, filePartName] */</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">args</span> <span class="o">=</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">slice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">arguments</span><span class="p">),</span>
          <span class="nx">filepath</span> <span class="o">=</span> <span class="nx">args</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
          <span class="nx">filePartName</span> <span class="o">=</span> <span class="nx">args</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
          <span class="nx">filename</span> <span class="o">=</span> <span class="nx">path</span><span class="p">.</span><span class="nx">basename</span><span class="p">(</span><span class="nx">filepath</span><span class="p">);</span>
          
      <span class="nx">args</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">outgoing</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>TODO replace request/multipart with better implementation with
low memory consumption</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">fs</span><span class="p">.</span><span class="nx">readFile</span><span class="p">(</span><span class="nx">filepath</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">fileData</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">outgoing</span><span class="p">.</span><span class="nx">multipart</span> <span class="o">=</span> <span class="p">[{</span>
              <span class="s1">&#39;content-type&#39;</span><span class="o">:</span> <span class="s1">&#39;application/octet-stream&#39;</span><span class="p">,</span>
              <span class="s1">&#39;Content-Transfer-Encoding&#39;</span><span class="o">:</span> <span class="s1">&#39;binary&#39;</span><span class="p">,</span>
              <span class="s1">&#39;Content-Disposition&#39;</span><span class="o">:</span> <span class="s1">&#39;form-data; name=&quot;&#39;</span> <span class="o">+</span> <span class="nx">filePartName</span> <span class="o">+</span> <span class="s1">&#39;&quot;; filename=&quot;&#39;</span> <span class="o">+</span> <span class="nx">filename</span> <span class="o">+</span> <span class="s1">&#39;&quot;&#39;</span><span class="p">,</span>
              <span class="s1">&#39;body&#39;</span><span class="o">:</span> <span class="nx">fileData</span>
          <span class="p">}];</span>
          
          <span class="nx">request</span><span class="p">(</span><span class="nx">outgoing</span><span class="p">,</span> <span class="nx">callback</span><span class="p">);</span>  
        <span class="p">});</span>
      <span class="p">});</span>
      
      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_request</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;post&#39;</span><span class="p">].</span><span class="nx">concat</span><span class="p">(</span><span class="nx">args</span><span class="p">));</span>
    <span class="p">},</span>
    </pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <h3>Add Test Assertions</h3>

<p>Add test assertions with <code>.expect()</code>. There are a couple of options here:</p>

<ol>
<li>Assert a response code: <code>suite.expect(200)</code></li>
<li>Assert a JSON result: <code>suite.expect({ some: 'value' })</code></li>
<li>Use a custom assertion: <code>suite.expect('should be custom', function (err, res, body) { ... })</code></li>
</ol>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">expect</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="cm">/* [text, code, result, assert] */</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">args</span> <span class="o">=</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">slice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">arguments</span><span class="p">),</span>
          <span class="nx">text</span><span class="p">,</span> <span class="nx">code</span><span class="p">,</span> <span class="nx">result</span><span class="p">,</span> <span class="nx">test</span><span class="p">,</span> <span class="nx">context</span><span class="p">;</span>
      
      <span class="nx">args</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">arg</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">switch</span> <span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="nx">arg</span><span class="p">))</span> <span class="p">{</span>
          <span class="k">case</span> <span class="s1">&#39;number&#39;</span><span class="o">:</span> <span class="nx">code</span> <span class="o">=</span> <span class="nx">arg</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
          <span class="k">case</span> <span class="s1">&#39;string&#39;</span><span class="o">:</span> <span class="nx">text</span> <span class="o">=</span> <span class="nx">arg</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
          <span class="k">case</span> <span class="s1">&#39;object&#39;</span><span class="o">:</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">arg</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
          <span class="k">case</span> <span class="s1">&#39;function&#39;</span><span class="o">:</span> <span class="nx">test</span> <span class="o">=</span> <span class="nx">arg</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">});</span>
      
      <span class="nx">context</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_currentTest</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">current</span><span class="p">);</span>
      </pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>When using a custom test assertion function, both the assertion function
and a description are required or else we have no key in the JSON structure to use.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="p">(</span><span class="nx">text</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">test</span> <span class="o">||</span> <span class="nx">test</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">text</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;Both description and a custom test are required.&#39;</span><span class="p">);</span>
      <span class="p">}</span>
      </pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>Setup the custom test assertion if we have the appropriate arguments.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="p">(</span><span class="nx">text</span> <span class="o">&amp;&amp;</span> <span class="nx">test</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">context</span><span class="p">[</span><span class="nx">text</span><span class="p">]</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">body</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">assert</span><span class="p">.</span><span class="nx">isNull</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
          <span class="nx">test</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span>
        <span class="p">};</span>
      <span class="p">}</span>
      </pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>Setup the response code test assertion if we have the appropriate arguments.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="p">(</span><span class="nx">code</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">context</span><span class="p">[</span><span class="s1">&#39;should respond with &#39;</span> <span class="o">+</span> <span class="nx">code</span><span class="p">]</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">body</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">assert</span><span class="p">.</span><span class="nx">isNull</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
          <span class="nx">assert</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">statusCode</span><span class="p">,</span> <span class="nx">code</span><span class="p">);</span>
        <span class="p">};</span>
      <span class="p">}</span>
      </pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p>Setup the JSON response assertion if we have the appropriate arguments.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="p">(</span><span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">context</span><span class="p">[</span><span class="s1">&#39;should respond with &#39;</span> <span class="o">+</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">result</span><span class="p">).</span><span class="nx">substring</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">50</span><span class="p">)]</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">body</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <p>Pass any and all errors from parsing and asserting
the JSON returned to the underlying <code>vows</code> suite. </p>             </td>             <td class="code">               <div class="highlight"><pre>          <span class="nx">assert</span><span class="p">.</span><span class="nx">isNull</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
          <span class="kd">var</span> <span class="nx">testResult</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">body</span><span class="p">);</span>
          <span class="nx">assert</span><span class="p">.</span><span class="nx">deepEqual</span><span class="p">(</span><span class="nx">testResult</span><span class="p">,</span> <span class="nx">result</span><span class="p">);</span>
        <span class="p">};</span>
      <span class="p">}</span>
      
      <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
    <span class="p">},</span>
    </pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <p>Create some helper methods for setting important options
that will be later passed to <code>request</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">followRedirect</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">follow</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">outgoing</span><span class="p">.</span><span class="nx">followRedirect</span> <span class="o">=</span> <span class="nx">follow</span><span class="p">;</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
    <span class="p">},</span>
    <span class="nx">maxRedirects</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">max</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">outgoing</span><span class="p">.</span><span class="nx">maxRedirects</span> <span class="o">=</span> <span class="nx">max</span><span class="p">;</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
    <span class="p">},</span>
    </pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <h3>Perform Sequential Tests Easily</h3>

<p>Since this object literal is designed to manage a single vows suite, 
we need a way to add multiple batches to that suite for performing
sequential tests. This is precisely what <code>.next()</code> does. It will:</p>

<ol>
<li>Add the current batch (or 'vows'), <code>this.batch</code>, to the vows suite</li>
<li>Add this same batch to the set of batches on <code>this.batches</code></li>
<li>Create a new empty object literal to use for <code>this.batch</code>.</li>
<li>Reset the context for the <code>this.current</code> test. </li>
</ol>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">next</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">suite</span><span class="p">.</span><span class="nx">addBatch</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">batch</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">batches</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">batch</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">batch</span> <span class="o">=</span> <span class="p">{};</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">current</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
    <span class="p">},</span>
    </pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <h3>Run Your Tests</h3>

<p>Again, since we are managing a single vows suite in this object we 
should expose an easy way to export your tests to a given target without
needing to call <code>apiEasySuite.suite.export(module)</code>. You should only 
call this method once in a given test file.  </p>

<p>You can also call <code>.run()</code> which will run the specified suite just 
as if you were using vows directly.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kr">export</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">target</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">batch</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">next</span><span class="p">();</span>
      <span class="p">}</span>
      
      <span class="k">this</span><span class="p">.</span><span class="nx">suite</span><span class="p">.</span><span class="kr">export</span><span class="p">(</span><span class="nx">target</span><span class="p">);</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
    <span class="p">},</span>
    <span class="nx">run</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">options</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">batch</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">next</span><span class="p">();</span>
      <span class="p">}</span>
      
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">callback</span> <span class="o">=</span> <span class="nx">options</span><span class="p">;</span>
        <span class="nx">options</span> <span class="o">=</span> <span class="p">{};</span>
      <span class="p">}</span>
      
      <span class="k">this</span><span class="p">.</span><span class="nx">suite</span><span class="p">.</span><span class="nx">run</span><span class="p">(</span><span class="nx">options</span><span class="p">,</span> <span class="nx">callback</span><span class="p">);</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
    <span class="p">},</span>
    </pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <h3>Use Vows from APIeasy</h3>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">addBatch</span> <span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">batch</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">next</span><span class="p">();</span>
      <span class="p">}</span>
      </pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-23">&#182;</a>               </div>               <p>injects <code>easy</code> methods into vows' suite to be able 
to switch back to APIEasy context</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
      <span class="p">[</span><span class="s1">&#39;get&#39;</span><span class="p">,</span> <span class="s1">&#39;post&#39;</span><span class="p">,</span> <span class="s1">&#39;del&#39;</span><span class="p">,</span> <span class="s1">&#39;put&#39;</span><span class="p">,</span> <span class="s1">&#39;head&#39;</span><span class="p">,</span> <span class="s1">&#39;uploadFile&#39;</span><span class="p">].</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">methodName</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">self</span><span class="p">.</span><span class="nx">suite</span><span class="p">[</span><span class="nx">methodName</span><span class="p">]</span> <span class="o">===</span> <span class="s1">&#39;undefined&#39;</span><span class="p">)</span> <span class="p">{</span>    
          <span class="nx">self</span><span class="p">.</span><span class="nx">suite</span><span class="p">[</span><span class="nx">methodName</span><span class="p">]</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">self</span><span class="p">[</span><span class="nx">methodName</span><span class="p">].</span><span class="nx">apply</span><span class="p">(</span><span class="nx">self</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span>
          <span class="p">}</span>
        <span class="p">}</span>  
      <span class="p">});</span>
      
      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">suite</span><span class="p">.</span><span class="nx">addBatch</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">suite</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span>
    <span class="p">},</span>
    </pre></div>             </td>           </tr>                               <tr id="section-24">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-24">&#182;</a>               </div>               <h3>Helpers and Utilities</h3>

<p><code>_request()</code> exists for the sake of DRY and simplicity and is designed to handle
a variety of interal usage(s) exposed indirectly through the <code>.get()</code>,
<code>.post()</code>, <code>.put()</code>, <code>.del()</code> and <code>.head()</code>. Nothing to see here unless you're 
interested in improving APIeasy itself.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">_request</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="cm">/* method [uri, data, params] */</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">self</span>    <span class="o">=</span> <span class="k">this</span><span class="p">,</span>
          <span class="nx">args</span>    <span class="o">=</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">slice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">arguments</span><span class="p">),</span>
          <span class="nx">method</span>  <span class="o">=</span> <span class="nx">args</span><span class="p">.</span><span class="nx">shift</span><span class="p">(),</span>
          <span class="nx">uri</span>     <span class="o">=</span> <span class="k">typeof</span> <span class="nx">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">===</span> <span class="s1">&#39;string&#39;</span> <span class="o">&amp;&amp;</span> <span class="nx">args</span><span class="p">.</span><span class="nx">shift</span><span class="p">(),</span>
          <span class="nx">data</span>    <span class="o">=</span> <span class="k">typeof</span> <span class="nx">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">===</span> <span class="s1">&#39;object&#39;</span> <span class="o">&amp;&amp;</span> <span class="nx">args</span><span class="p">.</span><span class="nx">shift</span><span class="p">(),</span>
          <span class="nx">params</span>  <span class="o">=</span> <span class="k">typeof</span> <span class="nx">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">===</span> <span class="s1">&#39;object&#39;</span> <span class="o">&amp;&amp;</span> <span class="nx">args</span><span class="p">.</span><span class="nx">shift</span><span class="p">(),</span>
          </pre></div>             </td>           </tr>                               <tr id="section-25">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-25">&#182;</a>               </div>               <p>custom request implementation function (outgoing, callaback),
should invoke callback(err, response, body) once done</p>             </td>             <td class="code">               <div class="highlight"><pre>          <span class="nx">requestImpl</span> <span class="o">=</span> <span class="k">typeof</span> <span class="nx">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">===</span> <span class="s1">&#39;function&#39;</span> <span class="o">&amp;&amp;</span> <span class="nx">args</span><span class="p">.</span><span class="nx">shift</span><span class="p">(),</span>
          <span class="nx">port</span>    <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">port</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">port</span> <span class="o">!==</span> <span class="mi">80</span> <span class="o">?</span> <span class="s1">&#39;:&#39;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">port</span> <span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
          <span class="nx">outgoing</span> <span class="o">=</span> <span class="nx">clone</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">outgoing</span><span class="p">),</span>
          <span class="nx">fullUri</span><span class="p">,</span> <span class="nx">context</span><span class="p">;</span>
      </pre></div>             </td>           </tr>                               <tr id="section-26">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-26">&#182;</a>               </div>               <p>Update the fullUri for this request with the passed uri
and the query string parameters (if any).</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">fullUri</span> <span class="o">=</span> <span class="nx">distillPath</span><span class="p">(</span><span class="nx">uri</span> <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">paths</span><span class="p">.</span><span class="nx">concat</span><span class="p">([</span><span class="nx">uri</span><span class="p">])</span> <span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">paths</span><span class="p">);</span>
      </pre></div>             </td>           </tr>                               <tr id="section-27">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-27">&#182;</a>               </div>               <p>Append the query string parameters to the <code>fullUri</code>. It's worth mentioning
here that if only a single object is provided to <code>_request()</code> it will assume
that it is the request body, not the params hash.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="p">(</span><span class="nx">params</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">fullUri</span> <span class="o">+=</span> <span class="s1">&#39;?&#39;</span> <span class="o">+</span> <span class="nx">qs</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">params</span><span class="p">);</span>
      <span class="p">}</span>
      </pre></div>             </td>           </tr>                               <tr id="section-28">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-28">&#182;</a>               </div>               <p>If the user has provided data, assume that it is JSON 
and set it to the <code>body</code> property of the options. </p>

<p><strong>TODO <em>(indexzero)</em></strong>: Expose more properties available by the 
<a href="http://github.com/mikeal/request">request module</a></p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">outgoing</span><span class="p">.</span><span class="nx">headers</span><span class="p">[</span><span class="s1">&#39;Content-Type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;application/x-www-form-urlencoded&#39;</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">outgoing</span><span class="p">.</span><span class="nx">body</span> <span class="o">=</span> <span class="nx">qs</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
        <span class="p">}</span> 
        <span class="k">else</span> <span class="p">{</span>
          <span class="nx">outgoing</span><span class="p">.</span><span class="nx">body</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">}</span>
      </pre></div>             </td>           </tr>                               <tr id="section-29">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-29">&#182;</a>               </div>               <p>Set the <code>uri</code> and <code>method</code> properties of the request options <code>outgoing</code>
using the information provided to this instance and <code>_request()</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">outgoing</span><span class="p">.</span><span class="nx">uri</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">secure</span> <span class="o">?</span> <span class="s1">&#39;https://&#39;</span> <span class="o">:</span> <span class="s1">&#39;http://&#39;</span><span class="p">;</span>
      <span class="nx">outgoing</span><span class="p">.</span><span class="nx">uri</span> <span class="o">+=</span> <span class="k">this</span><span class="p">.</span><span class="nx">host</span> <span class="o">+</span> <span class="nx">port</span> <span class="o">+</span> <span class="nx">fullUri</span><span class="p">;</span>
      <span class="nx">outgoing</span><span class="p">.</span><span class="nx">method</span> <span class="o">=</span> <span class="nx">method</span><span class="p">;</span>
      </pre></div>             </td>           </tr>                               <tr id="section-30">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-30">&#182;</a>               </div>               <p>Create the description for this test. This is currently static.
<strong>Remark <em>(indexzero)</em></strong>: Do users care if these strings are configurable?</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">this</span><span class="p">.</span><span class="nx">current</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="nx">method</span><span class="p">.</span><span class="nx">toUpperCase</span><span class="p">(),</span> <span class="s1">&#39;to&#39;</span><span class="p">,</span> <span class="nx">fullUri</span><span class="p">].</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">);</span>
      <span class="nx">context</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_currentTest</span><span class="p">();</span>
      </pre></div>             </td>           </tr>                               <tr id="section-31">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-31">&#182;</a>               </div>               <p>Add the topic for the specified request to the context of the current
batch used by this suite. </p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">context</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">current</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">topic</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-32">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-32">&#182;</a>               </div>               <p>Before making the outgoing HTTP request for this topic, execute
all known before funtions available to this suite. These functions 
are by definition synchronous add vows before a given test if
this data is fetched asynchronously. </p>             </td>             <td class="code">               <div class="highlight"><pre>          <span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">befores</span><span class="p">).</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">outgoing</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">befores</span><span class="p">[</span><span class="nx">name</span><span class="p">](</span><span class="nx">outgoing</span><span class="p">);</span>
          <span class="p">});</span> 
          
          <span class="k">if</span> <span class="p">(</span><span class="nx">requestImpl</span><span class="p">)</span>
            <span class="nx">requestImpl</span><span class="p">(</span><span class="nx">outgoing</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">callback</span><span class="p">);</span>
          <span class="k">else</span>
            <span class="nx">request</span><span class="p">(</span><span class="nx">outgoing</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">callback</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">};</span>
      </pre></div>             </td>           </tr>                               <tr id="section-33">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-33">&#182;</a>               </div>               <p>Set the outgoing request options and set of before functions on the topic. 
This is used for test assertions, general consistency, and basically 
just knowing what every topic does explicitly.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">context</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">current</span><span class="p">].</span><span class="nx">topic</span><span class="p">.</span><span class="nx">outgoing</span> <span class="o">=</span> <span class="nx">outgoing</span><span class="p">;</span>
      <span class="nx">context</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">current</span><span class="p">].</span><span class="nx">topic</span><span class="p">.</span><span class="nx">before</span>   <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">befores</span><span class="p">;</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
    <span class="p">},</span>
    </pre></div>             </td>           </tr>                               <tr id="section-34">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-34">&#182;</a>               </div>               <p>The vows data structure is read as a sentence constructred by 
keys in a nested JSON structure. This helper method is designed to 
get the current test context (i.e. object) by nesting into the
JSON structure using this convention.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">_currentTest</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">text</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">last</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">batch</span><span class="p">;</span>
      </pre></div>             </td>           </tr>                               <tr id="section-35">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-35">&#182;</a>               </div>               <p>Nest into the batch JSON structure using the current <code>discussion</code> text. </p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">this</span><span class="p">.</span><span class="nx">discussion</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">text</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">last</span><span class="p">[</span><span class="nx">text</span><span class="p">]</span> <span class="o">!==</span> <span class="s1">&#39;object&#39;</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">last</span><span class="p">[</span><span class="nx">text</span><span class="p">]</span> <span class="o">=</span> <span class="p">{};</span>
        <span class="p">}</span>
        </pre></div>             </td>           </tr>                               <tr id="section-36">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-36">&#182;</a>               </div>               <p>Capture the nested object</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">last</span> <span class="o">=</span> <span class="nx">last</span><span class="p">[</span><span class="nx">text</span><span class="p">];</span>
      <span class="p">});</span>
      
      <span class="k">return</span> <span class="nx">text</span> <span class="o">?</span> <span class="nx">last</span><span class="p">[</span><span class="nx">text</span><span class="p">]</span> <span class="o">:</span> <span class="nx">last</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">};</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-37">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-37">&#182;</a>               </div>               <p>A simple function that performs a deep clone on the specified <code>obj</code>. 
We use this in APIeasy to create multiple copies of the <code>options</code> 
passed to <code>request</code> because they are considered mutable by <code>request</code>
and we strive to make each request idempotent. </p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">function</span> <span class="nx">clone</span> <span class="p">(</span><span class="nx">obj</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">copy</span> <span class="o">=</span> <span class="p">{};</span>
  <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="k">in</span> <span class="nx">obj</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">obj</span><span class="p">[</span><span class="nx">i</span><span class="p">]))</span> <span class="p">{</span>
      <span class="nx">copy</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">obj</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
      <span class="nx">copy</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">obj</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="k">instanceof</span> <span class="nb">Object</span> <span class="o">?</span> <span class="nx">clone</span><span class="p">(</span><span class="nx">obj</span><span class="p">[</span><span class="nx">i</span><span class="p">])</span> <span class="o">:</span> <span class="nx">obj</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="nx">copy</span><span class="p">;</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-38">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-38">&#182;</a>               </div>               <p>Helper function used to join nested paths created by 
multiple calls to <code>.path()</code>.</p>

<pre><code>suite.path('/a-path')
     .path('/hey-another-path')
     .path(...)
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">function</span> <span class="nx">distillPath</span> <span class="p">(</span><span class="nx">paths</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="nx">paths</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">p</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">p</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/^\/|\/$/ig</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">);</span>
  <span class="p">}).</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">);</span>
<span class="p">}</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 